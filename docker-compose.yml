name: nginx-proxy

services:
  ingress-public:
    container_name: ingress-public
    image: nginx:${NGINX_IMAGE_TAG:-latest}
    depends_on:
      - docker-gen-public
    networks:
      - dmz
      - private
    volumes:
      - ${PROJECT_PATH}/nginx-proxy-volume/conf/network_internal.conf:/etc/nginx/network_internal.conf:ro
      - ${PROJECT_PATH}/nginx-proxy-volume/conf.d/public:/etc/nginx/conf.d:ro
      - ${PROJECT_PATH}/nginx-proxy-volume/vhost.d/public:/etc/nginx/vhost.d:ro
      - ${PROJECT_PATH}/nginx-proxy-volume/html:/usr/share/nginx/html:ro
      - ${PROJECT_PATH}/nginx-proxy-volume/certs:/etc/nginx/certs:ro
    labels:
      - ${NGINX_PROXY_PUBLIC_INSTANCE_LABEL}=true
      - ${PUBLIC_NGINX_CONTAINER_LABEL}=true
      - com.github.nginx-proxy.nginx=true
    ports:
      - "${PUBLIC_PORT_HTTP}:80"
      - "${PUBLIC_PORT_HTTPS}:443"

  docker-gen-public:
    container_name: docker-gen-public
    image: nginxproxy/docker-gen:${DOCKER_GEN_IMAGE_TAG:-latest}
    network_mode: "none"
    environment:
      - NGINX_CONTAINER_LABEL=${PUBLIC_NGINX_CONTAINER_LABEL}
      - CONTAINER_FILTER_LABEL=${NGINX_PROXY_PUBLIC_INSTANCE_LABEL}
    volumes:
      - ${PROJECT_PATH}/nginx-proxy-volume/templates/nginx.tmpl:/etc/docker-gen/templates/nginx.tmpl:ro
      - ${PROJECT_PATH}/nginx-proxy-volume/conf.d/public:/etc/nginx/conf.d:rw
      - ${PROJECT_PATH}/nginx-proxy-volume/vhost.d/public:/etc/nginx/vhost.d:ro
      - ${PROJECT_PATH}/nginx-proxy-volume/certs:/etc/nginx/certs:ro
      # Share docker socket to listen to docker events
      - /var/run/docker.sock:/tmp/docker.sock:ro
    labels:
      - ${NGINX_PROXY_PUBLIC_INSTANCE_LABEL}=true
      - com.github.nginx-proxy.docker-gen=true
    command: -notify-signal 1 -notify-filter label=${PUBLIC_NGINX_CONTAINER_LABEL}=false -watch -wait 5s:30s /etc/docker-gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf

  acme-companion:
    container_name: acme-companion
    image: nginxproxy/acme-companion:%{ACME_COMPANION_IMAGE_TAG:-latest}
    depends_on:
      - docker-gen-public
    environment:
      - DEFAULT_EMAIL=${ACME_EMAIL}
    labels:
      - com.github.nginx-proxy.instance1=true
    volumes:
      - ${PROJECT_PATH}/nginx-proxy-volume/html:/usr/share/nginx/html:rw
      - ${PROJECT_PATH}/nginx-proxy-volume/certs:/etc/nginx/certs:rw
      - ${PROJECT_PATH}/nginx-proxy-volume/acme:/etc/acme.sh:rw
      # Share docker socket to listen to docker events
      - /var/run/docker.sock:/var/run/docker.sock:ro

  your-1st-app:
    depends_on:
      - acme-companion
    environment:
      VIRTUAL_HOST: your-1st-app.example.com,your-1st-app-private.example.com
      # VIRTUAL_PORT: 3000 # (OPTIONAL. If your app port is different from default port: 80)
      # LETSENCRYPT_HOST: your-app.example.com
      # LETSENCRYPT_EMAIL: ${ACME_EMAIL} # (OPTIONAL. Uses DEFAULT_EMAIL if defined in acme-companion)
      # VIRTUAL_HOST_MULTIPORTS: |-
      #     your-2nd-app.example.com:
      #     your-app.example.com:
      #       "/":
      #         port: 80
    labels:
      - ${NGINX_PROXY_PUBLIC_INSTANCE_LABEL}=true
      - ${NGINX_PROXY_PRIVATE_INSTANCE_LABEL}=true
    container_name: "your-1st-app"
    image: nginx:${NGINX_IMAGE_TAG:-latest}
    ports:
      - "80"
    networks:
      - private

  your-2nd-app:
    depends_on:
      - acme-companion
    environment:
      VIRTUAL_HOST: your-2nd-app.example.com
      # VIRTUAL_PORT: 3000 # (OPTIONAL. If your app port is different from default port: 80)
      # LETSENCRYPT_HOST: your-app.example.com
      # LETSENCRYPT_EMAIL: ${ACME_EMAIL} # (OPTIONAL. Uses DEFAULT_EMAIL if defined in acme-companion)
    labels:
      - ${NGINX_PROXY_PUBLIC_INSTANCE_LABEL}=true
    container_name: "your-2nd-app"
    image: nginx:${NGINX_IMAGE_TAG:-latest}
    ports:
      - "80"
    networks:
      - private

  your-3rd-app:
    depends_on:
      - acme-companion
    environment:
      VIRTUAL_HOST: your-3rd-app.example.com
      # VIRTUAL_PORT: 3000 # (OPTIONAL. If your app port is different from default port: 80)
      # LETSENCRYPT_HOST: your-app.example.com
      # LETSENCRYPT_EMAIL: ${ACME_EMAIL} # (OPTIONAL. Uses DEFAULT_EMAIL if defined in acme-companion)
    labels:
      - ${NGINX_PROXY_PRIVATE_INSTANCE_LABEL}=true
    container_name: "your-3rd-app"
    image: nginx:${NGINX_IMAGE_TAG:-latest}
    ports:
      - "80"
    networks:
      - private

networks:
  dmz:
  public:
    # driver: bridge
    # driver_opts:
    #   com.docker.network.bridge.host_binding_ipv4: "127.0.0.1"
  private:
    internal: true
